<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Monitoramento de Área</title>

  <!-- Suporte a PWA em iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Monitoramento de Área">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Manifesto e tema -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      z-index: 999;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="status">Localizando...</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').then(reg => {
          console.log('Service Worker registrado:', reg);
        }).catch(err => {
          console.error('Erro ao registrar Service Worker:', err);
        });
      });
    }

    const statusDiv = document.getElementById('status');
    const map = L.map('map').setView([-23.66448, -46.52791], 18);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const areas = [
      {
        nome: "Pracinha",
        coords: [
          [-23.66448, -46.52791],
          [-23.66456, -46.52782],
          [-23.66467, -46.5279],
          [-23.6646, -46.52801],
          [-23.66448, -46.52791]
        ]
      },
      {
        nome: "Siqueira Campos",
        coords: [
          [-23.66412, -46.52895],
          [-23.66395, -46.52893],
          [-23.66405, -46.52877],
          [-23.66412, -46.52895]
        ]
      }
    ];

    const polygons = areas.map(area => {
      const polygon = L.polygon(area.coords, {
        color: 'transparent',
        fillOpacity: 0,
        stroke: false
      }).addTo(map);
      polygon.nome = area.nome;
      return polygon;
    });

    function isInsideAnyPolygon(latlng) {
      for (let polygon of polygons) {
        const polyLatLngs = polygon.getLatLngs()[0];
        const polyPoints = polyLatLngs.map(p => [p.lat, p.lng]);
        if (pointInPolygon([latlng.lat, latlng.lng], polyPoints)) {
          return polygon.nome;
        }
      }
      return null;
    }

    function pointInPolygon(point, vs) {
      let x = point[0], y = point[1];
      let inside = false;
      for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        let xi = vs[i][0], yi = vs[i][1];
        let xj = vs[j][0], yj = vs[j][1];

        let intersect = ((yi > y) !== (yj > y)) &&
                        (x < (xj - xi) * (y - yi) / (yj - yi + 0.0000001) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function updateStatusAndMarker(latlng) {
      const areaNome = isInsideAnyPolygon(latlng);
      if (areaNome) {
        statusDiv.textContent = `Você está dentro da área: ${areaNome}`;
        statusDiv.style.background = '#d4ffd4';
      } else {
        statusDiv.textContent = 'Fora da área monitorada';
        statusDiv.style.background = '#ffd4d4';
      }
    }

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const preview = location.hostname === "localhost" || location.hostname === "127.0.0.1";

    if (preview || !isMobile) {
      const marker = L.marker([-23.66448, -46.52791], { draggable: true }).addTo(map);
      updateStatusAndMarker(marker.getLatLng());
      marker.on('drag', e => {
        const latlng = e.target.getLatLng();
        updateStatusAndMarker(latlng);
      });
    } else if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        position => {
          const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
          map.setView(latlng);
          updateStatusAndMarker(latlng);
        },
        error => {
          console.error('Erro ao obter localização:', error);
          switch (error.code) {
            case error.PERMISSION_DENIED:
              statusDiv.textContent = 'Permissão de localização negada pelo usuário.';
              break;
            case error.POSITION_UNAVAILABLE:
              statusDiv.textContent = 'Informações de localização indisponíveis.';
              break;
            case error.TIMEOUT:
              statusDiv.textContent = 'Tempo excedido ao tentar obter localização.';
              break;
            default:
              statusDiv.textContent = 'Erro desconhecido ao obter localização.';
              break;
          }
          statusDiv.style.background = '#ffcccc';
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000
        }
      );
    } else {
      statusDiv.textContent = 'Geolocalização não suportada pelo navegador.';
      statusDiv.style.background = '#ffcccc';
    }
  </script>
</body>
</html>
